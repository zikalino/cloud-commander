- name: Azure
  id: cloud-azure
  icon: azure.png
  subitems: []
  raw: {}
  details: az__prerequisites.yaml
  query: az group list
  path-id: $[::].id
  path-name: $[::].name
  path-raw: $[::]
  operations:
    - type: create
      name: Create Resource Group
      template: az_group_create
    - type: create
      name: Create Virtual Machine
      template: generic_vm_create
    - type: create
      name: Create Container Registry
      template: az_acr_create
  child-template:
    # this is a template for resource group level
    - type: delete
      name: Delete
      cmd: az resource delete --ids ${id}
      refresh: parent
    - type: query
      query: az resource list --resource-group ${name}
      path-id: $[::].id
      path-name: $[::].name
      path-raw: $[::]
    # This is copied from level below, but is exactly the same
    - type: query-details
      when:
        path: "$.type"
        value: "Microsoft.Compute/virtualMachines"
        compare: ne
      query: az resource show --ids ${id}
      refresh: self
      extract:
        - field: location
          path: "$.location"

    - type: child-template
      # this is a template for any resource in the resource group
      template:
        # delete is the same for any resouce in tre resource group
        - type: delete
          name: Delete
          cmd: az resource delete --ids ${id}
          refresh: parent
        - type: start
          name: Start
          cmd: az vm start --ids ${id}
          refresh: self
          when:
            path: "$.instanceView.statuses[?(@.code < 'ProvisioningState')].code"
            value: "PowerState/stopped"
        - type: stop
          name: Stop
          cmd: az vm stop --ids ${id}
          refresh: self
          when:
            path: "$.instanceView.statuses[?(@.code < 'ProvisioningState')].code"
            value: "PowerState/running"
        - type: restart
          name: Restart
          cmd: az vm restart --ids ${id}
          refresh: self
          when:
            path: "$.instanceView.statuses[?(@.code < 'ProvisioningState')].code"
            value: "PowerState/running"

        # This is details query for VMs only
        - type: query-details
          when:
            path: "$.type"
            value: "Microsoft.Compute/virtualMachines"
          query: az vm get-instance-view --ids ${id}
          refresh: self
          extract:
            - field: state
              path: "$.instanceView.statuses[?(@.code < 'ProvisioningState')].code"
              map:
                "PowerState/running": started
                "PowerState/stopped": stopped
            - field: size
              path: "$.hardwareProfile.vmSize"
            - field: size_disk
              path: "$.storageProfile.osDisk.diskSizeGb"
            - field: location
              path: "$.location"
        # This is details query for any other resources
        - type: query-details
          when:
            path: "$.type"
            value: "Microsoft.Compute/virtualMachines"
            compare: ne
          query: az resource show --ids ${id}
          refresh: self
          extract:
            - field: location
              path: "$.location"
